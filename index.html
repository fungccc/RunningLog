<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Log Pro - å°ˆæ¥­è·‘è€…é›²ç«¯æ—¥èªŒ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0d6efd; --bg: #f0f2f5; --card-bg: #ffffff; }
        body { background-color: var(--bg); font-family: "Microsoft JhengHei", system-ui, sans-serif; padding-bottom: 100px; }
        
        /* è¨“ç·´å¼·åº¦é¡è‰²æ¨™è¨˜ */
        .rpe-badge { font-weight: bold; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; }
        .rpe-easy { background-color: #28a745; }   /* 1-3 */
        .rpe-mod { background-color: #ffc107; color: #333; } /* 4-6 */
        .rpe-hard { background-color: #fd7e14; }   /* 7-8 */
        .rpe-max { background-color: #dc3545; }    /* 9-10 */

        .card { border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 15px; overflow: hidden; }
        .card-header-custom { background: linear-gradient(to right, #f8f9fa, #fff); border-bottom: 1px solid #eee; padding: 10px 15px; }
        
        /* çµ„åˆå¼è¨“ç·´é …ç›®æ¨£å¼ */
        .workout-segment { border-left: 4px solid #dee2e6; padding-left: 10px; margin-bottom: 8px; position: relative; }
        .workout-segment.run { border-left-color: #0d6efd; }
        .workout-segment.strength { border-left-color: #d63384; }
        .workout-segment.cross { border-left-color: #198754; }
        .delete-seg-btn { position: absolute; right: 0; top: 0; color: #dc3545; cursor: pointer; opacity: 0.5; }
        .delete-seg-btn:hover { opacity: 1; }

        /* è£œçµ¦æ¨™ç±¤ */
        .nutrition-tag { display: inline-block; background: #e3f2fd; color: #0c5460; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; margin-right: 5px; margin-bottom: 3px; }
        
        .fab-btn {
            position: fixed; bottom: 30px; right: 30px; width: 64px; height: 64px;
            border-radius: 50%; box-shadow: 0 4px 20px rgba(13, 110, 253, 0.4);
            font-size: 28px; z-index: 1000; display: flex; align-items: center; justify-content: center;
            background-color: var(--primary); color: white; border: none; transition: transform 0.2s;
        }
        .fab-btn:hover { transform: scale(1.05); }

        .login-cover {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0d6efd, #0dcaf0);
            z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;
        }
    </style>
</head>
<body>

<div id="app">
    <div v-if="loading" style="position:fixed; inset:0; background:rgba(255,255,255,0.8); z-index:9999; display:flex; justify-content:center; align-items:center;">
        <div class="spinner-border text-primary"></div>
    </div>

    <div v-if="!user" class="login-cover">
        <h1 class="mb-3"><i class="fa-solid fa-stopwatch"></i> Running Log Pro</h1>
        <p class="mb-5 opacity-75">çµ„åˆå¼è¨“ç·´æ—¥èªŒ â€¢ è³½äº‹ç´€éŒ„ â€¢ é›²ç«¯å‚™ä»½</p>
        <button class="btn btn-light btn-lg px-5 shadow rounded-pill fw-bold text-primary" @click="googleLogin">
            <i class="fab fa-google me-2"></i> ä½¿ç”¨ Google ç™»å…¥
        </button>
    </div>

    <div v-else class="container py-3">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h5 class="mb-0 fw-bold text-dark">{{ user.displayName }} çš„è¨“ç·´æ—¥èªŒ</h5>
                <small class="text-muted" v-if="lastBackup">ä¸Šæ¬¡å‚™ä»½: {{ lastBackup }}</small>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">è¨­å®š</button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    <li><a class="dropdown-item" href="#" @click="forceBackup"><i class="fa-solid fa-download me-2"></i>ä¸‹è¼‰å‚™ä»½ (CSV)</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" @click="logout"><i class="fa-solid fa-sign-out-alt me-2"></i>ç™»å‡º</a></li>
                </ul>
            </div>
        </div>

        <div class="row g-2 mb-3">
            <div class="col-8">
                <input type="text" v-model="filters.keyword" class="form-control" placeholder="ğŸ” æœå°‹èª²è¡¨åç¨±ã€ç­†è¨˜...">
            </div>
            <div class="col-4">
                <select v-model="filters.type" class="form-select">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="training">è¨“ç·´</option>
                    <option value="race">è³½äº‹</option>
                </select>
            </div>
        </div>

        <div v-if="activities.length === 0" class="text-center py-5 text-muted">
            <i class="fa-solid fa-person-running fa-3x mb-3 opacity-50"></i>
            <p>å°šæœªæœ‰ç´€éŒ„ï¼Œé»æ“Šå³ä¸‹è§’ã€Œ+ã€é–‹å§‹ç¬¬ä¸€ç­†è¨“ç·´ï¼</p>
        </div>

        <div v-for="act in filteredActivities" :key="act.id" class="card" @click="editActivity(act)" style="cursor:pointer">
            <div class="card-header-custom d-flex justify-content-between align-items-center">
                <div>
                    <span class="badge me-2" :class="act.type === 'race' ? 'bg-danger' : 'bg-primary'">
                        {{ act.type === 'race' ? 'è³½äº‹' : 'è¨“ç·´' }}
                    </span>
                    <span class="fw-bold">{{ act.date }}</span>
                    <span class="ms-2 text-muted small">{{ act.startTime }}</span>
                </div>
                <div class="text-secondary small">
                    <span v-if="act.totalDistance > 0">{{ act.totalDistance }}k</span>
                    <span v-if="act.totalDuration" class="ms-2"><i class="fa-regular fa-clock"></i> {{ act.totalDuration }}</span>
                </div>
            </div>
            
            <div class="card-body py-2">
                <h5 class="card-title fw-bold mb-2">{{ act.name }}</h5>
                
                <div v-if="act.type === 'race'" class="mb-2 p-2 bg-light rounded border border-warning small">
                    <div class="row g-1">
                        <div class="col-6">ğŸ† å¤§æœƒ: <b>{{ act.officialTime || '--' }}</b></div>
                        <div class="col-6">â± æ™¶ç‰‡: <b>{{ act.chipTime || '--' }}</b></div>
                        <div class="col-12 text-truncate" v-if="act.location"><i class="fa-solid fa-location-dot"></i> {{ act.location }}</div>
                    </div>
                </div>

                <div v-if="act.type === 'training' && act.components && act.components.length > 0">
                    <div v-for="(comp, idx) in act.components" :key="idx" 
                         class="d-flex justify-content-between align-items-center small text-secondary mb-1 ps-2 border-start border-3"
                         :class="getBorderClass(comp.category)">
                        <span class="text-truncate" style="max-width: 65%;">
                            {{ comp.subCategory }} <span v-if="comp.distance" class="text-dark">({{comp.distance}}k)</span>
                        </span>
                        <span>
                            <span v-if="comp.pace" class="me-1 bg-light px-1 rounded">{{comp.pace}}</span>
                            <span class="rpe-badge" :class="getRpeClass(comp.rpe)">RPE {{comp.rpe}}</span>
                        </span>
                    </div>
                </div>

                <div v-if="act.nutrition && act.nutrition.length > 0" class="mt-2 pt-2 border-top small">
                    <i class="fa-solid fa-bolt text-warning"></i> è£œçµ¦: 
                    <span class="text-muted">{{ act.nutrition.length }} æ¬¡</span>
                    <span class="ms-2 text-primary" v-if="calculateNutritionInterval(act.nutrition)">
                        (å¹³å‡é–“éš”: {{ calculateNutritionInterval(act.nutrition) }} åˆ†)
                    </span>
                </div>
                
                <div v-if="act.note" class="mt-2 text-muted small text-truncate">
                    <i class="fa-regular fa-comment-dots"></i> {{ act.note }}
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editorModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">{{ isEdit ? 'ç·¨è¼¯ç´€éŒ„' : 'æ–°å¢ç´€éŒ„' }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body bg-light">
                    <div class="card p-3 mb-3">
                        <div class="row g-3">
                            <div class="col-12">
                                <label class="form-label fw-bold">é¡å‹</label>
                                <div class="btn-group w-100" role="group">
                                    <input type="radio" class="btn-check" value="training" v-model="form.type" id="typeTrain">
                                    <label class="btn btn-outline-primary" for="typeTrain">æ—¥å¸¸è¨“ç·´ (çµ„åˆå¼)</label>
                                    <input type="radio" class="btn-check" value="race" v-model="form.type" id="typeRace">
                                    <label class="btn btn-outline-danger" for="typeRace">æ­£å¼è³½äº‹</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <label class="form-label">æ—¥æœŸ</label>
                                <input type="date" v-model="form.date" class="form-control">
                            </div>
                            <div class="col-6">
                                <label class="form-label">èµ·è·‘æ™‚é–“</label>
                                <input type="time" v-model="form.startTime" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label">åç¨± / æ¨™é¡Œ</label>
                                <input type="text" v-model="form.name" class="form-control" :placeholder="form.type==='race'?'ä¾‹: 2025 æ¸£æ‰“é¦¬æ‹‰æ¾':'ä¾‹: æ™¨é–“æœ‰æ°§ + è¡åˆº'">
                            </div>
                        </div>
                    </div>

                    <div v-if="form.type === 'race'" class="card p-3 mb-3 border-warning">
                        <h6 class="text-warning-emphasis mb-3"><i class="fa-solid fa-trophy"></i> è³½äº‹æˆç¸¾</h6>
                        <div class="row g-3">
                            <div class="col-6"><label>å¤§æœƒæ™‚é–“</label><input type="text" v-model="form.officialTime" placeholder="hh:mm:ss" class="form-control"></div>
                            <div class="col-6"><label>æ™¶ç‰‡æ™‚é–“</label><input type="text" v-model="form.chipTime" placeholder="hh:mm:ss" class="form-control"></div>
                            <div class="col-6"><label>åœ°é»</label><input type="text" v-model="form.location" class="form-control"></div>
                            <div class="col-3"><label>ç¸½æ’å</label><input type="text" v-model="form.rankOverall" class="form-control"></div>
                            <div class="col-3"><label>åˆ†çµ„</label><input type="text" v-model="form.rankCat" class="form-control"></div>
                            <div class="col-12"><label>å¤©æ°£/æº«åº¦</label><input type="text" v-model="form.weather" class="form-control"></div>
                        </div>
                    </div>

                    <div class="card p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0 fw-bold text-primary">
                                <i class="fa-solid fa-layer-group"></i> è¨“ç·´å…§å®¹çµ„åˆ
                            </h6>
                            <button class="btn btn-sm btn-outline-primary" @click="addComponent">
                                <i class="fa-solid fa-plus"></i> åŠ å…¥æ®µè½
                            </button>
                        </div>
                        
                        <div v-if="form.components.length === 0" class="text-center text-muted small py-3 border rounded border-dashed">
                            å°šæœªæ·»åŠ è¨“ç·´å…§å®¹
                        </div>

                        <div v-for="(comp, idx) in form.components" :key="idx" class="workout-segment bg-white rounded p-2 mb-2 shadow-sm" :class="getBorderClass(comp.category)">
                            <i class="fa-solid fa-times delete-seg-btn p-2" @click="removeComponent(idx)"></i>
                            
                            <div class="row g-1 mb-2">
                                <div class="col-5">
                                    <select v-model="comp.category" class="form-select form-select-sm" @change="resetSubCat(comp)">
                                        <option v-for="(subs, main) in categoryData" :key="main" :value="main">{{ main }}</option>
                                    </select>
                                </div>
                                <div class="col-7">
                                    <select v-model="comp.subCategory" class="form-select form-select-sm">
                                        <option v-for="sub in categoryData[comp.category] || []" :key="sub" :value="sub">{{ sub }}</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row g-1 align-items-center">
                                <div class="col-3">
                                    <input type="number" step="0.01" v-model="comp.distance" class="form-control form-control-sm" placeholder="è·é›¢(k)">
                                </div>
                                <div class="col-3">
                                    <input type="text" v-model="comp.duration" class="form-control form-control-sm" placeholder="æ™‚é–“(mm:ss)">
                                </div>
                                <div class="col-6 d-flex align-items-center">
                                    <label class="small text-muted me-2 text-nowrap">RPE: <span :class="'rpe-badge '+getRpeClass(comp.rpe)">{{comp.rpe}}</span></label>
                                    <input type="range" class="form-range" min="1" max="10" v-model.number="comp.rpe">
                                </div>
                            </div>
                            <div class="mt-2">
                                <input type="text" v-model="comp.note" class="form-control form-control-sm" placeholder="å‚™è¨» (ä¾‹å¦‚: å‡é€Ÿ 4:30/k, æ„Ÿè¦ºè‰¯å¥½)">
                            </div>
                        </div>
                        
                        <div class="text-end small text-secondary mt-2">
                            ç¸½è·é›¢: <b>{{ totalDistCalc }}</b> km
                        </div>
                    </div>

                    <div class="card p-3 mb-3">
                        <h6 class="mb-2 fw-bold text-success"><i class="fa-solid fa-bottle-water"></i> è£œçµ¦ç´€éŒ„</h6>
                        <div class="input-group mb-2">
                            <input type="number" v-model="nutriInput.time" class="form-control" placeholder="é–‹è·‘å¾Œå¹¾åˆ† (min)">
                            <select v-model="nutriInput.type" class="form-select">
                                <option value="æ°´">ğŸ’§ æ°´</option>
                                <option value="é›»è§£æ°´">âš¡ é›»è§£æ°´</option>
                                <option value="èƒ½é‡GEL">ğŸš€ èƒ½é‡ GEL</option>
                                <option value="é¹½ä¸¸">ğŸ§‚ é¹½ä¸¸</option>
                                <option value="BCAA">ğŸ’Š BCAA</option>
                                <option value="å›ºé«”é£Ÿç‰©">ğŸŒ å›ºé«”é£Ÿç‰©</option>
                            </select>
                            <button class="btn btn-success" @click="addNutrition">ç´€éŒ„</button>
                        </div>
                        
                        <div class="d-flex flex-wrap gap-2">
                            <div v-for="(nut, idx) in sortedNutrition" :key="idx" class="nutrition-tag d-flex align-items-center">
                                <b>{{ nut.time }}'</b>: {{ nut.type }}
                                <i class="fa-solid fa-xmark ms-2" style="cursor:pointer; font-size:0.8em" @click="removeNutrition(idx)"></i>
                            </div>
                        </div>
                        <div v-if="sortedNutrition.length > 1" class="alert alert-info py-1 px-2 mt-2 mb-0 small">
                            <i class="fa-solid fa-chart-line"></i> å¹³å‡è£œçµ¦é–“éš”: <b>{{ calculateNutritionInterval(form.nutrition) }}</b> åˆ†é˜
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ç¸½çµå¿ƒå¾—</label>
                        <textarea v-model="form.note" class="form-control" rows="3"></textarea>
                    </div>

                </div>
                <div class="modal-footer">
                    <button v-if="isEdit" type="button" class="btn btn-outline-danger me-auto" @click="deleteActivity">åˆªé™¤</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" @click="saveActivity">å„²å­˜ç´€éŒ„</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="backupModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">ğŸ“… æœˆåˆå‚™ä»½æé†’</h5>
                </div>
                <div class="modal-body">
                    <p>é€™æ˜¯æ‚¨æœ¬æœˆç¬¬ä¸€æ¬¡ç™»å…¥ã€‚</p>
                    <p>å»ºè­°ä¸‹è¼‰ CSV å‚™ä»½æ‚¨çš„è¨“ç·´èˆ‡è³½äº‹è³‡æ–™ã€‚</p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" @click="performBackup">
                            <i class="fa-solid fa-file-csv"></i> ä¸‹è¼‰å‚™ä»½æª”æ¡ˆ
                        </button>
                        <button class="btn btn-link text-secondary" data-bs-dismiss="modal">ç¨å¾Œå†èªª</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button class="fab-btn" @click="openAddModal"><i class="fa-solid fa-plus"></i></button>

</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, getDocs, addDoc, updateDoc, deleteDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // TODO: è«‹å¡«å…¥æ‚¨çš„ Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyCw7o8V-QW5M9Px7lcx4hOCAxW7oNKLhak",
  authDomain: "runninglog-8da12.firebaseapp.com",
  projectId: "runninglog-8da12",
  storageBucket: "runninglog-8da12.firebasestorage.app",
  messagingSenderId: "600035565062",
  appId: "1:600035565062:web:5ae746eadd2b0c6d5c6d87",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // å®Œæ•´çš„åˆ†é¡æ•¸æ“šçµæ§‹
    const CATEGORY_DATA = {
        "ä¸€ã€è·‘æ­¥é¡ (å¼·åº¦/ç›®çš„)": [
            "è¼•é¬†è·‘ Easy run", "æ¢å¾©è·‘ Recovery run", "æœ‰æ°§è€åŠ›è·‘ Aerobic run", "ç©©æ…‹è·‘ Steady run",
            "ç¯€å¥è·‘ Tempo run", "ä¹³é…¸é–€æª» Threshold run", "5km æ¯”è³½é…é€Ÿ", "10km æ¯”è³½é…é€Ÿ",
            "åŠé¦¬ æ¯”è³½é…é€Ÿ", "å…¨é¦¬é…é€Ÿ (MP)", "æ¼¸é€Ÿè·‘ Progression", "è² åˆ†æ®µè·‘ Negative split",
            "é–“æ­‡è·‘ Intervals (VO2max)", "é‡è¤‡è·‘ Repeats", "è¡åˆº Sprint", "æ³•ç‰¹èŠå…‹ Fartlek",
            "çˆ¬å¡è¨“ç·´ Hill repeats", "ä¸‹å¡è¨“ç·´ Downhill", "åŠ›é‡è€åŠ›è·‘ Strength-endurance"
        ],
        "ä¸€ã€è·‘æ­¥é¡ (è·é›¢/å½¢å¼)": [
            "é•·è·é›¢è·‘ Long run", "è¶…é•·èª² Overdistance", "åˆ†æ®µé•·èª² Split long run",
            "é›™èª² Doubles (AM/PM)", "é…é€Ÿè®ŠåŒ–é•·èª²", "5km æ¸¬é©— (Time trial)",
            "10km æ¸¬é©— (Time trial)", "åŠé¦¬ æ¸¬é©— (Time trial)", "åŠ é€Ÿè·‘ Strides", "è·‘å§¿æ“ Drills"
        ],
        "ä¸€ã€è·‘æ­¥é¡ (æŠ€è¡“)": [
            "è·‘å§¿è¨“ç·´ Running drills", "æ­¥é »/è½åœ°æŠ€å·§", "ç¶“æ¿Ÿæ€§è¨“ç·´"
        ],
        "äºŒã€è‚ŒåŠ›èˆ‡åŠ›é‡": [
            "ä¸‹è‚¢è‚ŒåŠ› (æ·±è¹²/ç¡¬æ‹‰)", "ä¸Šè‚¢/èƒŒéƒ¨", "æ ¸å¿ƒ Core", "è‚Œè€åŠ›", "çˆ†ç™¼åŠ› Power",
            "å¢å¼·å¼ Plyometrics", "å°è‚Œç¾¤å•Ÿå‹• Glute activation"
        ],
        "ä¸‰ã€äº¤å‰è¨“ç·´": [
            "å–®è»Š (å…¬è·¯/å®¤å…§)", "æ¸¸æ³³", "åˆ’è‰‡æ©Ÿ Rowing", "æ©¢åœ“æ©Ÿ Elliptical",
            "ç™»å±±/è¡Œå±± Hiking", "æ»‘é›ªæ©Ÿ SkiErg", "æ°´ä¸­è·‘ Aqua jogging", "è·³ç¹©"
        ],
        "å››ã€ä¿é¤Šèˆ‡æ¢å¾©": [
            "å‹•æ…‹ç†±èº« Warm-up", "å†·èº« Cool-down", "ä¼¸å±• Stretching", "æ´»å‹•åº¦ Mobility",
            "æ»¾ç­’æ”¾é¬† Foam rolling", "å¹³è¡¡è¨“ç·´", "ç‰©ç†æ²»ç™‚/å¾©å¥",
            "ä¼‘æ¯æ—¥ Rest day", "ä¸»å‹•æ¢å¾© Active recovery"
        ],
        "å…­ã€ç’°å¢ƒé©æ‡‰": [
            "ç†±é©æ‡‰ Heat", "é«˜åœ°é©æ‡‰ Altitude", "è¶Šé‡/åœ°å½¢è¨“ç·´", "è£å‚™æ¸¬è©¦"
        ]
    };

    const { createApp, ref, computed, onMounted, reactive } = Vue;

    createApp({
        setup() {
            const user = ref(null);
            const loading = ref(true);
            const activities = ref([]);
            const categoryData = CATEGORY_DATA;
            const filters = reactive({ keyword: '', type: 'all' });
            
            // Modal å¯¦ä¾‹
            let editorModal = null;
            let backupModal = null;

            // è¡¨å–®æ•¸æ“š
            const isEdit = ref(false);
            const currentId = ref(null);
            const form = reactive(getEmptyForm());
            const nutriInput = reactive({ time: '', type: 'èƒ½é‡GEL' });
            const lastBackup = ref(null);

            function getEmptyForm() {
                return {
                    type: 'training',
                    date: new Date().toISOString().slice(0, 10),
                    startTime: '06:00',
                    name: '',
                    components: [], // çµ„åˆå¼è¨“ç·´å…§å®¹
                    nutrition: [],  // è£œçµ¦ç´€éŒ„
                    note: '',
                    // Race specific
                    officialTime: '', chipTime: '', location: '', rankOverall: '', rankCat: '', weather: ''
                };
            }

            // ç™»å…¥ç›£è½èˆ‡åˆå§‹åŒ–
            onMounted(() => {
                editorModal = new bootstrap.Modal(document.getElementById('editorModal'));
                backupModal = new bootstrap.Modal(document.getElementById('backupModal'));

                onAuthStateChanged(auth, async (u) => {
                    if (u) {
                        user.value = u;
                        await loadActivities();
                        await checkBackup();
                    } else {
                        user.value = null;
                        activities.value = [];
                    }
                    loading.value = false;
                });
            });

            // --- æ ¸å¿ƒé‚è¼¯ ---

            // è¨ˆç®—é¡¯ç¤ºç”¨æ•¸æ“š
            const filteredActivities = computed(() => {
                return activities.value.filter(act => {
                    const matchKey = (act.name + (act.note||"")).toLowerCase().includes(filters.keyword.toLowerCase());
                    const matchType = filters.type === 'all' || act.type === filters.type;
                    return matchKey && matchType;
                });
            });

            const totalDistCalc = computed(() => {
                return form.components.reduce((sum, c) => sum + (parseFloat(c.distance) || 0), 0).toFixed(2);
            });

            const sortedNutrition = computed(() => {
                return [...form.nutrition].sort((a,b) => a.time - b.time);
            });

            // è¼‰å…¥è³‡æ–™
            async function loadActivities() {
                const q = query(collection(db, `users/${user.value.uid}/activities`), orderBy("date", "desc"));
                const snap = await getDocs(q);
                activities.value = snap.docs.map(d => {
                    const data = d.data();
                    // é å…ˆè¨ˆç®—ç¸½çµæ•¸æ“šä»¥åˆ©é¡¯ç¤º
                    let totalDist = 0;
                    let totalDur = ""; // æš«ä¸åŠ ç¸½æ™‚é–“å­—ä¸²ï¼Œå¤ªè¤‡é›œ
                    if(data.components) {
                        totalDist = data.components.reduce((sum, c) => sum + (parseFloat(c.distance)||0), 0);
                    }
                    return { id: d.id, ...data, totalDistance: parseFloat(totalDist.toFixed(2)) };
                });
            }

            // --- ç·¨è¼¯å™¨æ“ä½œ ---
            function openAddModal() {
                isEdit.value = false;
                Object.assign(form, getEmptyForm());
                // é è¨­åŠ ä¸€å€‹ç©ºçš„è·‘æ­¥å€å¡Š
                form.components.push({ category: "ä¸€ã€è·‘æ­¥é¡ (å¼·åº¦/ç›®çš„)", subCategory: "è¼•é¬†è·‘ Easy run", distance: "", duration: "", rpe: 3, note: "" });
                editorModal.show();
            }

            function editActivity(act) {
                isEdit.value = true;
                currentId.value = act.id;
                // æ·±æ‹·è²é¿å…ç›´æ¥ä¿®æ”¹åˆ—è¡¨
                Object.assign(form, JSON.parse(JSON.stringify(act)));
                // ç¢ºä¿ components å­˜åœ¨
                if(!form.components) form.components = [];
                if(!form.nutrition) form.nutrition = [];
                editorModal.show();
            }

            function addComponent() {
                form.components.push({ category: "ä¸€ã€è·‘æ­¥é¡ (å¼·åº¦/ç›®çš„)", subCategory: "è¼•é¬†è·‘ Easy run", distance: "", duration: "", rpe: 5, note: "" });
            }

            function removeComponent(idx) {
                form.components.splice(idx, 1);
            }

            function resetSubCat(comp) {
                // åˆ‡æ›å¤§é¡æ™‚ï¼Œè‡ªå‹•é¸ç¬¬ä¸€å€‹å­é¡
                const subs = categoryData[comp.category];
                if(subs && subs.length > 0) comp.subCategory = subs[0];
            }

            function addNutrition() {
                if(nutriInput.time === '') return;
                form.nutrition.push({ time: parseInt(nutriInput.time), type: nutriInput.type });
                nutriInput.time = ''; // æ¸…ç©ºè¼¸å…¥
            }

            function removeNutrition(idx) {
                form.nutrition.splice(idx, 1);
            }

            // --- å„²å­˜èˆ‡åˆªé™¤ ---
            async function saveActivity() {
                const uid = user.value.uid;
                const payload = { ...form, updatedAt: serverTimestamp() };
                
                try {
                    if (isEdit.value) {
                        await updateDoc(doc(db, `users/${uid}/activities`, currentId.value), payload);
                    } else {
                        payload.createdAt = serverTimestamp();
                        await addDoc(collection(db, `users/${uid}/activities`), payload);
                    }
                    editorModal.hide();
                    loadActivities();
                } catch(e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
            }

            async function deleteActivity() {
                if(!confirm("ç¢ºå®šè¦åˆªé™¤ï¼Ÿ")) return;
                await deleteDoc(doc(db, `users/${user.value.uid}/activities`, currentId.value));
                editorModal.hide();
                loadActivities();
            }

            // --- è¼”åŠ©åŠŸèƒ½ ---
            function getRpeClass(rpe) {
                if(rpe <= 3) return 'rpe-easy';
                if(rpe <= 6) return 'rpe-mod';
                if(rpe <= 8) return 'rpe-hard';
                return 'rpe-max';
            }
            
            function getBorderClass(cat) {
                if(cat.includes("è·‘æ­¥")) return "run";
                if(cat.includes("è‚ŒåŠ›")) return "strength";
                if(cat.includes("äº¤å‰")) return "cross";
                return "";
            }

            function calculateNutritionInterval(nutList) {
                if(!nutList || nutList.length < 2) return null;
                const sorted = [...nutList].sort((a,b) => a.time - b.time);
                let diffSum = 0;
                for(let i=1; i<sorted.length; i++) {
                    diffSum += (sorted[i].time - sorted[i-1].time);
                }
                return (diffSum / (sorted.length - 1)).toFixed(1);
            }

            // --- å‚™ä»½æ©Ÿåˆ¶ ---
            async function checkBackup() {
                const userDocRef = doc(db, "users", user.value.uid);
                const snap = await getDoc(userDocRef);
                const nowStr = new Date().toISOString().slice(0, 7); // YYYY-MM

                if(snap.exists()) {
                    const data = snap.data();
                    lastBackup.value = data.lastBackupMonth;
                    if(data.lastBackupMonth !== nowStr) {
                        backupModal.show();
                    }
                    updateDoc(userDocRef, { lastLoginAt: serverTimestamp() });
                } else {
                    setDoc(userDocRef, { createdAt: serverTimestamp(), lastLoginAt: serverTimestamp() });
                }
            }

            async function performBackup() {
                // ç”¢ç”Ÿ CSV
                const header = ["Type", "Date", "Name", "TotalDist", "Components(JSON)", "Nutrition(JSON)", "Note"];
                const rows = activities.value.map(act => [
                    act.type, act.date, `"${act.name}"`, act.totalDistance, 
                    `"${JSON.stringify(act.components).replace(/"/g, '""')}"`,
                    `"${JSON.stringify(act.nutrition).replace(/"/g, '""')}"`,
                    `"${(act.note||"").replace(/"/g, '""')}"`
                ]);
                
                const csvContent = "\uFEFF" + [header.join(","), ...rows.map(r => r.join(","))].join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `RunningBackup_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(link);
                link.click();
                
                // æ›´æ–°å‚™ä»½ç´€éŒ„
                const nowStr = new Date().toISOString().slice(0, 7);
                await updateDoc(doc(db, "users", user.value.uid), { lastBackupMonth: nowStr });
                lastBackup.value = nowStr;
                backupModal.hide();
            }

            // Auth
            const googleLogin = () => signInWithPopup(auth, provider);
            const logout = () => signOut(auth);
            const forceBackup = () => backupModal.show();

            return {
                user, loading, activities, filteredActivities, categoryData,
                filters, form, isEdit, nutriInput, lastBackup, sortedNutrition,
                googleLogin, logout, openAddModal, editActivity, saveActivity, deleteActivity,
                addComponent, removeComponent, resetSubCat, addNutrition, removeNutrition,
                getRpeClass, getBorderClass, calculateNutritionInterval, performBackup, forceBackup, totalDistCalc
            };
        }
    }).mount('#app');
</script>
</body>
</html>
