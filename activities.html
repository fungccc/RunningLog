<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Running Log - æ´»å‹•ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="firebase-config.js"></script>
    <script src="csv-utils.js"></script>
</head>
<body class="bg-gray-100 text-gray-800">

<div id="app" class="max-w-4xl mx-auto p-4">
    <header class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">ğŸƒ Running Log</h1>
        <div v-if="user">
            <span>{{ user.displayName }}</span>
            <button @click="logout" class="ml-2 text-sm text-red-500 underline">ç™»å‡º</button>
        </div>
        <button v-else @click="login" class="bg-blue-600 text-white px-4 py-2 rounded">Google ç™»å…¥</button>
    </header>

    <div v-if="showBackupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded shadow-lg max-w-sm w-full">
            <h3 class="text-lg font-bold mb-2">ğŸ“… æ¯æœˆå‚™ä»½æé†’</h3>
            <p class="mb-4 text-gray-600">é€™æ˜¯æœ¬æœˆç¬¬ä¸€æ¬¡ç™»å…¥ï¼Œå»ºè­°å‚™ä»½æ‚¨çš„è¨“ç·´è³‡æ–™ã€‚</p>
            <div class="flex flex-col gap-2">
                <button @click="exportData" class="bg-green-600 text-white py-2 rounded">ä¸‹è¼‰å‚™ä»½ CSV</button>
                <button @click="dismissBackup" class="text-gray-500 py-2">æœ¬æœˆä¸å†æé†’</button>
            </div>
        </div>
    </div>

    <div v-if="user" class="bg-white p-4 rounded shadow mb-6 flex gap-4">
        <select v-model="filterMonth" class="border p-2 rounded">
            <option value="">æ‰€æœ‰æœˆä»½</option>
            <option value="2025-12">2025-12</option>
            <option value="2025-11">2025-11</option>
            </select>
        <select v-model="filterType" class="border p-2 rounded">
            <option value="all">å…¨éƒ¨é¡å‹</option>
            <option value="race">æ¯”è³½</option>
            <option value="training">è¨“ç·´</option>
        </select>
    </div>

    <div v-if="user" class="mb-6">
        <label class="block mb-2 font-bold">åŒ¯å…¥èˆŠæ¯”è³½è¨˜éŒ„ (demo_rrlog.csv)</label>
        <input type="file" @change="handleFileUpload" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
    </div>

    <div v-if="user">
        <div v-for="act in filteredActivities" :key="act.id" class="bg-white p-4 rounded shadow mb-4 border-l-4" :class="act.type === 'race' ? 'border-red-500' : 'border-blue-500'">
            <div class="flex justify-between">
                <div class="font-bold text-lg">
                    {{ act.date }} 
                    <span v-if="act.type === 'race'">ğŸ† {{ act.raceNameZh || act.raceName }}</span>
                    <span v-else>ğŸƒ {{ act.workoutTitle || 'è¨“ç·´' }}</span>
                </div>
                <div class="text-gray-500">{{ act.distanceKm }} km</div>
            </div>
            <div class="text-sm text-gray-600 mt-1">
                æ™‚é–“: {{ act.officialTimeStr || formatDuration(act.durationSec) }} | 
                åœ°é»: {{ act.locationName }}
            </div>
            <div v-if="act.note" class="text-sm text-gray-400 mt-2 bg-gray-50 p-2 rounded">
                ğŸ“ {{ act.note }}
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    createApp({
        setup() {
            const user = ref(null);
            const activities = ref([]);
            const filterMonth = ref("");
            const filterType = ref("all");
            const showBackupModal = ref(false);

            // ç™»å…¥
            const login = async () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                try {
                    await auth.signInWithPopup(provider);
                    // ç™»å…¥å¾Œ onAuthStateChanged æœƒè§¸ç™¼
                } catch (e) {
                    console.error(e);
                }
            };

            const logout = () => auth.signOut();

            // ç›£è½ User ç‹€æ…‹ä¸¦è®€å–è³‡æ–™
            auth.onAuthStateChanged(async (u) => {
                user.value = u;
                if (u) {
                    // 1. æª¢æŸ¥å‚™ä»½æé†’
                    checkBackupReminder(u);
                    // 2. è®€å–æ´»å‹•è³‡æ–™
                    loadActivities(u.uid);
                } else {
                    activities.value = [];
                }
            });

            // æª¢æŸ¥å‚™ä»½é‚è¼¯
            const checkBackupReminder = async (u) => {
                const docRef = db.collection('users').doc(u.uid);
                const docSnap = await docRef.get();
                const currentMonth = new Date().toISOString().slice(0, 7); // "YYYY-MM"
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    if (data.lastBackupMonth !== currentMonth) {
                        showBackupModal.value = true;
                    }
                } else {
                    // æ–°ç”¨æˆ¶åˆå§‹åŒ–
                    await docRef.set({
                        email: u.email,
                        createdAt: new Date(),
                        lastBackupMonth: null
                    });
                    // æ–°ç”¨æˆ¶ä¹Ÿå¯èƒ½éœ€è¦æé†’å‚™ä»½? è¦–éœ€æ±‚è€Œå®š
                }
            };

            const dismissBackup = async () => {
                const currentMonth = new Date().toISOString().slice(0, 7);
                await db.collection('users').doc(user.value.uid).update({
                    lastBackupMonth: currentMonth
                });
                showBackupModal.value = false;
            };
            
            const exportData = () => {
                alert("æ­¤è™•å°‡è§¸ç™¼ CSV ä¸‹è¼‰é‚è¼¯ (æ•´åˆ csv-utils.js)");
                dismissBackup();
            };

            // è®€å–æ´»å‹•
            const loadActivities = async (uid) => {
                const snap = await db.collection('users').doc(uid).collection('activities').orderBy('date', 'desc').get();
                activities.value = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            };

            // åŒ¯å…¥ CSV è™•ç†
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const newActivities = parseCSV(text); // å‘¼å« csv-utils.js
                    
                    if (confirm(`è§£æå‡º ${newActivities.length} ç­†è³‡æ–™ï¼Œç¢ºå®šåŒ¯å…¥ï¼Ÿ`)) {
                        const batch = db.batch();
                        const colRef = db.collection('users').doc(user.value.uid).collection('activities');
                        
                        newActivities.forEach(act => {
                            const docRef = colRef.doc(); // Auto ID
                            batch.set(docRef, act);
                        });
                        
                        await batch.commit();
                        alert("åŒ¯å…¥æˆåŠŸï¼");
                        loadActivities(user.value.uid); // é‡æ•´
                    }
                };
                reader.readAsText(file);
            };

            // ç¯©é¸é‚è¼¯
            const filteredActivities = computed(() => {
                return activities.value.filter(act => {
                    if (filterType.value !== 'all' && act.type !== filterType.value) return false;
                    if (filterMonth.value && !act.date.startsWith(filterMonth.value)) return false;
                    return true;
                });
            });

            // æ™‚é–“æ ¼å¼åŒ–è¼”åŠ©
            const formatDuration = (sec) => {
                if(!sec) return "--";
                const h = Math.floor(sec / 3600);
                const m = Math.floor((sec % 3600) / 60);
                const s = sec % 60;
                return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            };

            return {
                user, login, logout,
                activities, filteredActivities,
                filterMonth, filterType,
                handleFileUpload,
                showBackupModal, dismissBackup, exportData,
                formatDuration
            };
        }
    }).mount('#app');
</script>
</body>
</html>
